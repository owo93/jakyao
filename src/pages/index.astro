---
import Layout from "../layouts/Layout.astro";
import { getSecret } from "astro:env/server";

const target = new Date(getSecret("TARGET_JAKYAO_DATE")!).getTime();
const overtime = Date.now() > target;
const sk_generation = Number(getSecret("SK_GENERATION"));
---

<Layout>
    <div class="flex flex-col h-dvh p-6 items-center">
        <div class="flex flex-col flex-1 items-center justify-center gap-4">
            <div class="text-2xl font-mono">
                <span><span id="days"></span> days</span>
                <span><span id="hours"></span> hours</span>
                <span><span id="minutes"></span> minutes</span>
                <span><span id="seconds"></span> seconds</span>
            </div>

            {overtime ? "after" : "until"} jakyao SK{sk_generation}
        </div>

        {
            new Intl.DateTimeFormat("en-GB", {
                timeZone: "asia/bangkok",
                dateStyle: "long",
                timeStyle: "long",
            }).format(target)
        }
    </div>
</Layout>

    <script define:vars={{ target }}>
        function updateCountdown() {
            const diff = target - Date.now();

            const totalSeconds = Math.floor(diff / 1000);

            const days = Math.floor(totalSeconds / (3600 * 24));
            const hours = Math.floor((totalSeconds % (3600 * 24)) / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

    function updateCountdown() {
        const diff = target - Date.now();

        function tick() {
            updateCountdown();
            const delay = 1000 - (Date.now() % 1000);
            setTimeout(() => {
                updateCountdown();
                setInterval(updateCountdown, 1000);
            }, delay);
        }

        const totalSeconds = Math.floor(Math.abs(diff) / 1000);

        const values = {
            days: Math.floor(totalSeconds / (3600 * 24)),
            hours: Math.floor((totalSeconds % (3600 * 24)) / 3600),
            minutes: Math.floor((totalSeconds % 3600) / 60),
            seconds: totalSeconds % 60,
        };

        Object.entries(values).forEach(([id, value]) => {
            const el = document.getElementById(id);

            if (value > 0) {
                el.textContent = value.toString();
                el.parentNode.style.display = "inline";
            } else {
                el.parentNode.style.display = "none";
            }
        });
    }

    function tick() {
        updateCountdown();
        setTimeout(tick, 1000 - (Date.now() % 100));
    }

    tick();
</script>
